---
title: CyberAgent 2days サーバーサイド向け 開発型インターンシップ ONLINE に参加してきたログ
date: "2020-06-09"
template: "post"
draft: false
slug: "humane-typography-in-the-digital-age"
category: "Engineer"
tags:
  - "golang"
  - "intern"
description: "こんにちはとさです
6/7~6/8でCyberAgentの2dayサーバーサイド向け
開発型インターンシップに参加していました！"
socialImage: "/media/42-line-bible.jpg"
---

こんにちは
とさです

6/7~6/8でCyberAgentの2dayサーバーサイド向け
開発型インターンシップに参加していました！

まず初めに結果としては全体のちょうど半分の10位で終了しました。
なので、参加者の丁度中央だった自分がどのようにチューニングに挑戦していたのかを記録していきたいと思います。


## 実施前にやったこと
golangのプロファイリングツールであるpprofとnginxの計測ツールのalpについて調査とテストを行っていました。またisucon7の予選の解説pdfが販売されていたので購入してパラパラとめくって学習していました。

ただ、インターンシップの面接の際もnginx(エンジンエックス)について知っていますか？と聞かれた時点ではnginx(ネギシン)と読むのだと勘違いしていたくらい知識がありませんでした。


## 開始 〜 一日目前半

初期点は700くらい、まずはgithubにファイルをあげてローカルで開発しようとしたのですが、ファイル権限等の調節がうまくいかず、いじるファイルが少ないことからvimとscpによるファイル転送で開発していく方針に変更しました。(効率悪かったのでファイル権限をちゃんと設定するかvimが触れるなら直接変更した方が良いです)

```zsh
# scpコマンド
scp file_name hogehoge@hostname:/dirctory/
```

## 1日目 後半
途中でランチタイムが入り、周りの学生エンジニアさんと話せて息抜きをしつつ午後へ。

相変わらずgithubの設定で四苦八苦しつつ、そもそもgolangのサーバーの再起動の仕方がわからず...といろいろわからないことだらけだったので(だめだめ）ぐぐったりメンターさんに聞きながら作業を進めていました。
```zsh
# システムの再起動
# ここら辺はsystemdで管理されています！！
sudo systemctl restart hogehoge
```

またここら辺でnginx.confを操作の慣れていないvimでデータを吹き飛ばしたりしていました。（再度ファイルをもらいました、、お手数おかけします）（vimは:wqで保存されるので無意識に打ってしまいましたw皆さんも気をつけましょう）

alpを使用した解析を行いたかったのですがうまくいかず、メンターさんに聞いたところnginx.confではなく別の場所でも設定がありそちらのserverディレクティブに記入しなければならないらしく、、、時間を取られてしまいましたがようやく解析ができるようになりました。


## 初日解説〜終了

解析ができるようになった時点で初日解説の時間。
indexの貼り方一つでスピードが全然変わることに驚きでした。
slowクエリの調べ方や実際にindexが使用されているかの見方を解説してもらいました。

解説を参考にqueryを貼って700 -> 1300にスコアを上げることができました！（:ドヤ

その後、はslowクエリを探してindexを貼ったら高速化できそうなところに貼って1300 -> 1500にスコアを伸ばして初日は終了しました。

また、この日の夜に使用言語の指定処理をやり忘れていたみたいでphp -> golangに設定し直しました。

※ましさんに教えてもらいました、ありがとうございます！

## 2日目 前半

二日目はalpの解析結果をもとにログイン後の初期ページの動作が遅いことがわかってのでそこを改善していくことに、どうみてもアカウントのアイコン画像を表示する処理が重たい（base64で配信している）ことがわかったので直接静的ファイルを参照するように変更しました。

```
    location / {
        try_files $uri "${uri}.png" @backend;
    }
```
具体的には/photo/{id}を叩くと/photo/{id}.pngに直接参照するようにnginxのtry_filesを変更して改善すると、ホームページの画像がすごく早く表示するようになりました！

これはもしかしたら6000点を超えてしまうのではないか？トップあざす！と期待しながらベンチマークをすると得点が全く変わっていないという悲劇に。。。

ベンチマークが何を参考に得点を決めているのかをしっかり確認すべきだなと終わってみてから反省しています。

切り替えてスロークエリログを調査することに

```sql
mysql> set global slow_query_log = 1;
mysql> set global long_query_time = 0;
mysql> set global slow_query_log_file = "/tmp/slow.log";
bashに戻って
sudo pt-query-digest /tmp/slow.log > /tmp/digest.txt
```

解析をしてみるとおすすめ記事を表示するsqlが遅いことを確認！ここを改善してみようといろいろ頑張りましたがどうやらsqlの書き方自体に悪いところが見当たらず、、ちょっと行き詰まり感がありました。

## 2日目　後半

sqlが遅いのならば予めその値を保持できるのであれば保持しておいてsqlを実行せずにその値を返せばいいのでは？と思い立ちglobal変数に値を保持して、その値に関連する動作が起こったらflagを立ち上げて再度取得するように変更してみました。

```go
// 焦りすぎてスペル間違っているとか汚いとかはご愛敬
var (
	cachePopularArticle []PopularArticle
	chachOnlineUser     []int
	onlineflag     bool = false
	popflag        bool = false
	chachearticles int
	articlesflag   bool = false
	tagsCount      int
	tagsCountFlag  bool = false
)
```

この作業をしている間に時間は経ちscoreは1500 -> 1700に改善しました！
（ただ、不具合が生じることがありベンチマークがFAILすることも多かったです。）

※ 競技終了までこのれがインメモリ戦略だと思っていました。
※ 授業でメモリを習ったのに...

## 結果

最終結果は1723点が最大値で20人中ドンピシャで10位でした。2000点いきたかったですが、ガッツリ二日間集中して開発に打ち込めてとても楽しかったです！アドレナリン出まくりで初日が終了した時点で両腕が筋肉痛になる程、プログラミングが楽しいものだと再度実感しました。

競技終了後、解説があり。


* Mysqlインデックスチューイング
* インメモリキャッシュ、N+1除去
* golang特有のチューニング

の三つのステップで7500点を超えた事例の説明を受けました。redisによるインメモリキャッシュのやり方や、golangのtemplateエンジンがreflactによって遅くなっている部分の解消のやり方など、いろいろな観点で改善法を学べてめちゃくちゃ面白かったです！

また、nginxを外してgolangの80番を直接Listenするなど、これを使わなくてはいけない！っていう常識にとらわれて本質が見えていないと改善できない部分もありました。

当たり前ですが「知らない」技術はもちろん使うことができないので、こうした機会にいろいろな技術を「知る」ことができるのがとてもありがたいです。次回は是非今回学んだことを「使える」まで磨いて挑戦したいと思っています。




また、競技終了後CyberAgentさんのLTや社員懇談会もありいろいろな裏話が聞けてとても楽しかったです！社内の雰囲気がとてもよく伝わってきました。

個人的に社内インフラのサーバーの画像をみたときにめちゃくちゃかっこいい！ここで寝転がりたい！
って興奮したのが印象に残っています。


次はISUCONにも出場する予定なのでのでもっと学習して予選突破目指して頑張りたいと思います！


---

## 競技中に参考にしたブログ

[【Golang】gobで変数をファイルに保存する](https://cipepser.hatenablog.com/entry/go-gob)

[ 【MySQL】遅いselect文の原因を調査する【explainの読み方】](https://qiita.com/mtanabe/items/33a80bf2749a872645e6)

[nginxのtry_filesわかりにくすぎ問題](https://tsyama.hatenablog.com/entry/try_files_is_difficult)

[ISUCON史上初の学生チーム優勝！ 勝利のカギは「チームワーク」と「失敗からの学び](https://thinkit.co.jp/article/15737)

LTでこの記事に載っていた本物の人が出てきて驚きましたw

---

## 他の参加者のブログ

技術的な視点からとても勉強になりますので是非！

[さんぽしさん](https://sanposhiho.hatenablog.com/entry/2020/06/07/204415)

[kiyoさん](https://blog.shirakiyo.dev/post/ca-btc/)

[ましさん](https://mesimasi.com/backend-tuning-ca/)

[hppさん](https://hackmd.io/@hpp/ca-backend-tuning-competition)

[やよいさん](https://www.yayoibloglife.work/entry/2020/06/08/015922)

[Santos Kotaさん](https://qiita.com/kotaokubo/items/71586450309e437f2abb)

[AkkyOrzさん](https://akkyorz.hatenablog.com/entry/2020/06/08/165548)